//#SUB
//# COPYRIGHT cXXXXXXXXXX 2009
//##############################################################################
//#                                                                            #
//#      ＜＜　マミーマート様MD基幹システム−商品実績　＞＞                    #
//#                                                                            #
//#　プログラム名　　：　コントロール値追加処理                                #
//#　プログラムＩＤ　：　AppendBatchKey                                        #
//#　版　　　　　数　：　V1.0                                                  #
//#　作　　成　　日　：　2009.03.02                                            #
//#                                                                            #
//#　処理概要　：　コントロール値を指定テーブルに追加する                      #
//#                                                                            #
//#　パラメタ　：                                                              #
//#　　%1　―　テーブルパス                                                    #
//#　　%2　―　追加先テーブル                                                  #
//#　　%3　―　追加先集合ID                                                    #
//#　　%4　―　追加項目                                                        #
//#                                                                            #
//#　コメント　：　                                                            #
//#                                                                            #
//#　修正履歴：                                                                #
//#　　版数  日付        更新者     内容                                       #
//#　　----  ----------  ---------  -----------------------------------------  #
//#　　V1.0  2009.03.02  田中       新規作成                                   #
//##############################################################################

//##############################################################################
$echo ■ＳＵＢ１．初期処理
//##############################################################################
$ParaSet("%TBL_PATH",%1)
$ParaSet("%APPEND_TABLE",%2)
$ParaSet("%APPEND_CUR",%3)
$ParaSet("%CTRL_KEY",%4)

//##############################################################################
$echo ■ＳＵＢ２．本処理
//##############################################################################
//#結合キーを列を追加
$AddRealColumn("%APPEND_TABLE","[RecNo]","JOINT_KEY","String")
//#項目追加先テーブルに結合キーを追加
$Calc("%APPEND_TABLE","JOINT_KEY","1","*","$""%CTRL_KEY""","%APPEND_CUR")
//#コントロールテーブルをロード
$Load("%TBL_PATH","R_BATCH_CONTROL")

//#キー項目抽出
$MultiSearch("R_BATCH_CONTROL","1","""KEY_CD"" = '%CTRL_KEY'")
$ParaSet("%MAIN_TARGET_CUR","__SID")
$SetComment("R_BATCH_CONTROL","%MAIN_TARGET_CUR","キー項目抽出")

//#キー情報が取得できなければシステム的に問題あり→例外発生させる
$CHECK_ZERO("R_BATCH_CONTROL","%MAIN_TARGET_CUR")

//#結合
$CreateJoin("%APPEND_TABLE_JOIN","%APPEND_TABLE","R_BATCH_CONTROL","%APPEND_CUR","%MAIN_TARGET_CUR","=BEGIN=","JOINT_KEY","=END=","=BEGIN=","KEY_CD","=END=","INNER")
//#項目転送
$ColumnTransfer("%APPEND_TABLE_JOIN","VALUE_TX")

//##############################################################################
$echo ■ＳＵＢ３．終了処理
//##############################################################################
$Drop("%APPEND_TABLE_JOIN")
$Drop("R_BATCH_CONTROL")
$DelColumn("%APPEND_TABLE","JOINT_KEY")
$RenameColumn("%APPEND_TABLE","VALUE_TX","%CTRL_KEY")

