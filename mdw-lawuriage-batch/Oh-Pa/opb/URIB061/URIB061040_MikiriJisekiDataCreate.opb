//# COPYRIGHT cXXXXXXXXXX 2009
//##############################################################################
//#                                                                            #
//#      ＜＜　マミーマート様MD基幹システム−商品実績　＞＞                    #
//#                                                                            #
//#　プログラム名　　：　見切実績データ抽出処理                                #
//#　ジョブＩＤ　　　：　URIB061040                                            #
//#　プログラムＩＤ　：　MikiriJisekiDataCreate                                #
//#　版　　　　　数　：　V1.0                                                  #
//#　作　　成　　日　：　2009.05.11                                            #
//#                                                                            #
//#　処理概要　：　見切実績データ抽出処理                                      #
//#                                                                            #
//#　パラメタ　：                                                              #
//#　　%1　―　Commonファイルパス                                              #
//#　　%2　―　マクロファイルパス                                              #
//#　　%3　―　D5Tファイルパス                                                 #
//#　　%4　―　CSVファイルパス                                                 #
//#　　%5　―　カタログファイルパス                                            #
//#　　%6　―　法人コードパス                                                  #
//#　　%7　―　出力パス                                                        #
//#　コメント　：　(前提条件)                                                  #
//#                                                                            #
//#　修正履歴：                                                                #
//#　　版数  日付        更新者     内容                                       #
//#　　----  ----------  ---------  -----------------------------------------  #
//#　　V1.0  2009.05.11  松本       新規作成                                   #
//#　　V1.1  2009.07.03  VJC.福永   結果csvの出力先指定変更の為、引数変更      #
//#　　V1.2  2009.07.13  VJC.福永   対象の詳細区分取得をDICTIONARY_IDに修正    #
//#　　V1.3  2009.09.25  片山       見切実績ﾃﾞｰﾀ作成の対象ﾜｰｸﾃｰﾌﾞﾙを変更       #
//##############################################################################


//##########################################################################
$echo ■クリア
//##########################################################################
$ClearWS()
$ParaAllClear()


//##########################################################################
$echo ■パラメーターセット
//##########################################################################
//#Commonファイルパス
$ParaSet("%COMMON_PATH",%1)
//#マクロファイルパス
$ParaSet("%MAC_PATH",%2)
//#D5T格納パス
$ParaSet("%D5T_PATH",%3)
//#CSVパス
$ParaSet("%CSV_PATH",%4)
//#カタログパス
$ParaSet("%CTLG_PATH",%5)
//#法人コード
$ParaSet("%HOJIN_CD",%6)
//#　　V1.1  2009.07.03  VJC.福永   結果csvの出力先指定変更の為、引数変更      #
//#出力パス
$ParaSet("%OUT_PATH",%7)


//##########################################################################
$echo ■開始ログを出力
//##########################################################################
//# $SubExec("%COMMON_PATH","DebugLog.opb","=BEGIN=","URIB061040 見切実績データ抽出処理 処理を開始します","=END=")

//##########################################################################
$echo ■テーブルファイルをロード
//##########################################################################
$Load("%D5T_PATH","SYSTEM_CONTROL")
$Load("%D5T_PATH","DICTIONARY_CONTROL")
$Load("%D5T_PATH","WK_MIKIRI_POS")
//#$Load("%D5T_PATH","WK_NEJOGE_POS")

//# MOD 2009.09.25 Katayama 対象ワークテーブルの名称変更 STR
//##########################################################################
$echo ■対象データを抽出
//##########################################################################
//#システムコントロールマスタから値上下コードを取得
$MultiSearch("SYSTEM_CONTROL","1","""SUBSYSTEM_ID"" = 'URIAGE' AND ""PARAMETER_ID"" = 'MIKIRI_NEJOGE_SYOSAI_KB'")
$ParaSet("%TMP_TARGET_CUR","__SID")
$SetComment("SYSTEM_CONTROL","%TMP_TARGET_CUR","値上下コード")

//#システムディクショナリマスタから値上下コードを取得
$CreateJoin("SYSTEM_CONTROL_JOIN","SYSTEM_CONTROL","DICTIONARY_CONTROL","%TMP_TARGET_CUR","1","=BEGIN=","SUBSYSTEM_ID","PARAMETER_ID","=END=","=BEGIN=","SUBSYSTEM_ID","PARAMETER_ID","=END=","INNER")
//#　　V1.2  2009.07.13  VJC.福永   対象の詳細区分取得をDICTIONARY_IDに修正    #(PARAMETER_TX→DICTIONARY_ID)
$JoinRealize("SYSTEM_CONTROL_JOIN","SYSTEM_CONTROL_JOIN_REAL","1","N","N","=BEGIN=","DICTIONARY_CONTROL.DICTIONARY_ID","=END=")
$Drop("SYSTEM_CONTROL_JOIN")
$Drop("DICTIONARY_CONTROL")
$Rename("DICTIONARY_CONTROL","SYSTEM_CONTROL_JOIN_REAL")

//#コントロールマスタの値上下コードに対応するデータを抽出
//#　　V1.2  2009.07.13  VJC.福永   対象の詳細区分取得をDICTIONARY_IDに修正    #(PARAMETER_TX→DICTIONARY_ID)
$CreateJoin("WK_MIKIRI_POS_JOIN","WK_MIKIRI_POS","DICTIONARY_CONTROL","1","1","=BEGIN=","RIYU_SYOSAI_KB","=END=","=BEGIN=","DICTIONARY_ID","=END=","INNER")
$INOUT("WK_MIKIRI_POS_JOIN","N","N")
$ParaSet("%TMP_TARGET_CUR","__SID")
$SetComment("WK_MIKIRI_POS","%TMP_TARGET_CUR","対象データ")
$Drop("WK_MIKIRI_POS_JOIN")

//#不要な項目を削除
$DelColumn("WK_MIKIRI_POS","DENPYO_KB")
$DelColumn("WK_MIKIRI_POS","BUNRUI1_CD")
$DelColumn("WK_MIKIRI_POS","BUNRUI2_CD")
$DelColumn("WK_MIKIRI_POS","BUNRUI5_CD")
$DelColumn("WK_MIKIRI_POS","SYOHIN_HINMEI_KANJI_NA")
$DelColumn("WK_MIKIRI_POS","KIKAKU_KANJI_NA")
$DelColumn("WK_MIKIRI_POS","KIKAKU_KANJI_2_NA")
$DelColumn("WK_MIKIRI_POS","HINMEI_KANA_NA")
$DelColumn("WK_MIKIRI_POS","KIKAKU_KANA_NA")
$DelColumn("WK_MIKIRI_POS","KIKAKU_KANA_2_NA")
$DelColumn("WK_MIKIRI_POS","RIYU_KB")
$DelColumn("WK_MIKIRI_POS","RIYU_SYOSAI_KB")
$DelColumn("WK_MIKIRI_POS","ZEI_KB")
$DelColumn("WK_MIKIRI_POS","TAX_RT")
$DelColumn("WK_MIKIRI_POS","SHIIRE_SURYO_QT")
$DelColumn("WK_MIKIRI_POS","BAITANKA_OLD_VL")
$DelColumn("WK_MIKIRI_POS","BAITANKA_NEW_VL")
//#$DelColumn("WK_NEJOGE_POS","M_BAITANKA_VL")
$DelColumn("WK_MIKIRI_POS","M_BAITANKA_DAY_VL")
$DelColumn("WK_MIKIRI_POS","BAIKA_ZEINUKI_VL")
$DelColumn("WK_MIKIRI_POS","BAIKA_ZEIGAKU_VL")

//#項目を移動
$MoveColumn("WK_MIKIRI_POS","KANRI_DT","SYOHIN_CD")


//##########################################################################
$echo ■対象データを集計
//##########################################################################
//#対象データを集計
$XSUMNumeric("WK_MIKIRI_POS_SUM","WK_MIKIRI_POS","%TMP_TARGET_CUR","=BEGIN=","COMP_CD","TENPO_CD","SYOHIN_CD","KANRI_DT","=END=","=BEGIN=","SURYO_QT","0","0","0","-1","1","9","3","0","0","0","BAIKA_ZEIKOMI_VL","0","0","0","-1","1","13","0","0","0","0","=END=")

//#数値NULLの場合ゼロをセット
$Calc("WK_MIKIRI_POS_SUM","SUM<SURYO_QT>","1","*","NVL(@SUM<SURYO_QT>,0)","1")
$Calc("WK_MIKIRI_POS_SUM","SUM<BAIKA_ZEIKOMI_VL>","1","*","NVL(@SUM<BAIKA_ZEIKOMI_VL>,0)","1")

//#更新日時
$AddRealColumn("WK_MIKIRI_POS_SUM","SUM<BAIKA_ZEIKOMI_VL>","INSERT_USER_ID","String")
$AddRealColumn("WK_MIKIRI_POS_SUM","INSERT_USER_ID","INSERT_TS","String")
$AddRealColumn("WK_MIKIRI_POS_SUM","INSERT_TS","UPDATE_USER_ID","String")
$AddRealColumn("WK_MIKIRI_POS_SUM","UPDATE_USER_ID","UPDATE_TS","String")
$Calc("WK_MIKIRI_POS_SUM","INSERT_TS","1","*","$&($DateToStr(SYSDATE,1),$TimeToStr(SYSTIME,1))","1")
$Calc("WK_MIKIRI_POS_SUM","INSERT_USER_ID","1","*","$""URIB061""","1")
$Calc("WK_MIKIRI_POS_SUM","UPDATE_TS","1","*","$&($DateToStr(SYSDATE,1),$TimeToStr(SYSTIME,1))","1")
$Calc("WK_MIKIRI_POS_SUM","UPDATE_USER_ID","1","*","$""URIB061""","1")


//##########################################################################
$echo ■CSVファイル出力
//##########################################################################
//#CSV出力
//#　　V1.1  2009.07.03  VJC.福永   結果csvの出力先指定変更の為、引数変更      #
//$TxtWriteEx("WK_NEJOGE_POS_#1","CSV","%CSV_PATH","IF_DT_MIKIRI_JISEKI.csv","1","*","=BEGIN=","COMP_CD","TENPO_CD","SYOHIN_CD","KANRI_DT","SUM<SURYO_QT>","SUM<BAIKA_ZEIKOMI_VL>","INSERT_USER_ID","INSERT_TS","UPDATE_USER_ID","UPDATE_TS","=END=","N","1")
$TxtWriteEx("WK_MIKIRI_POS_SUM","CSV","%OUT_PATH","IF_DT_MIKIRI_JISEKI.csv","1","*","=BEGIN=","COMP_CD","TENPO_CD","SYOHIN_CD","KANRI_DT","SUM<SURYO_QT>","SUM<BAIKA_ZEIKOMI_VL>","INSERT_USER_ID","INSERT_TS","UPDATE_USER_ID","UPDATE_TS","=END=","N","1")

//# MOD 2009.09.25 Katayama 対象ワークテーブルの名称変更 END
//##########################################################################
$echo ■終了ログを出力
//##########################################################################
//# $SubExec("%COMMON_PATH","DebugLog.opb","=BEGIN=","URIB061040 見切実績データ抽出処理 処理を終了します","=END=")
